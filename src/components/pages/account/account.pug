mixin account-card(condition, model, title)
  b-box(:disabled=condition)
    b-level
      b-level-left
        h5 #{title}
      b-level-right
        label
          icon(v-if=condition, icon="lock")
          icon(v-else=condition, icon="lock-open-outline")
          b-switch(v-model=model)
    if block
      block

div.route-root
  b-container
    .section
      div(v-if="!currentUser._id")
        p
          | This page allows you to edit account details,
          | but you're not logged in.
        br
        p
          router-link.button.is-primary(to="/login") Click here to do so

      form(v-else="!currentUser._id", @submit.prevent="submitAccount")
        b-tile(is-parent, is-paddingless)
          b-tile(is-child)
            button.button.is-primary.is-pulled-right(
              type="submit",
              :disabled="this.editingCount === 0 || errors.any()",
              :class="{'is-loading': loading}"
            ) Save unlocked account details

        br
        b-columns
          b-column(is-6)
            .content
              h3 Account details

            hr
            +account-card("!editing.email", "editing.email", "E-mail address")
              b-tile(is-parent, is-vertical, is-paddingless)
                b-tile
                  b-tile(is-child, is-3)
                    .content
                      p Change to
                  b-tile(is-child, is-9)
                    b-control
                      b-input(v-model="account.email", :disabled="!editing.email")
                br
                b-tile
                  b-tile(is-child)
                    button.button.is-primary(
                      type="button",
                      :class="{'is-loading': loading}",
                      @click="resendVerification",
                      :disabled="!editing.email"
                    )
                      | Resend verification e-mail to the current address

            +account-card("!editing.password", "editing.password", "Passphrase")
              b-tile(is-parent, is-vertical, is-paddingless)
                b-tile(is-child)
                  .content
                    p Change to
                b-tile(is-child)
                  b-control
                    b-input(
                      name="password",
                      type="password",
                      v-model="account.password",
                      :disabled="!editing.password",
                      placeholder="Passphrase",
                      v-validate="'required'",
                      :class="{'is-danger': errors.has('password')}",
                      data-vv-as="passphrase",
                      aria-label="registration passphrase"
                    )
                  br
                  b-control
                    b-input(
                      name="passwordVerify",
                      type="password",
                      v-model="account.passwordVerify",
                      :disabled="!editing.password",
                      placeholder="Passphrase verification",
                      v-validate="'required|confirmed:password'",
                      :class="{'is-danger': errors.has('passwordVerify')}",
                      data-vv-as="passphrase verification",
                      aria-label="registration passphrase again"
                    )

          b-column(is-6)
            .content
              h3 Profile settings
            hr
            +account-card("!editing.donationUrl", "editing.donationUrl", "Donation link")
              b-tile(is-parent, is-vertical, is-paddingless)
                b-tile
                  b-tile(is-child, is-3)
                    .content
                      p Currently
                  b-tile(is-child, is-9)
                    b-control
                      b-input(:value="currentUser.donationUrl", disabled)
                br
                b-tile
                  b-tile(is-child, is-3)
                    .content
                      p Change to
                  b-tile(is-child, is-9)
                    b-control
                      b-input(v-model="account.donationUrl", :disabled="!editing.donationUrl")

            +account-card("!editing.displayname", "editing.displayname", "Username")
              b-tile(is-parent, is-vertical, is-paddingless)
                b-tile
                  b-tile(is-child, is-3)
                    .content
                      p Currently
                  b-tile(is-child, is-9)
                    b-control
                      b-input(:value="currentUser.displayname", disabled)
                br
                b-tile
                  b-tile(is-child, is-3)
                    .content
                      p Change to
                  b-tile(is-child, is-9)
                    b-control
                      b-input(v-model="account.displayname", :disabled="!editing.displayname")

            +account-card("!editing.bio", "editing.bio", "Bio")
              b-control
                b-textarea(v-model="account.bio", :disabled="!editing.bio")

              br
              b-box(:disabled="!editing.bio")
                .content
                  vue-markdown(
                    :source="account.bio",
                    :html="false",
                    :anchor-attributes="$anchorAttributes"
                  )

  ouc-footer
